<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>BubbleChat</title>
<style>
body{margin:0;font-family:Arial;background:#e8f0ff}
.app{width:360px;height:640px;margin:auto;background:white;border-radius:10px;overflow:hidden}
.top{background:#bde4a7;padding:10px;font-weight:bold;text-align:center}
.sidebar{width:140px;float:left;height:100%;background:#f3ffe8;overflow:auto}
.content{margin-left:140px;padding:10px;font-size:14px}
.friend{padding:6px;border-bottom:1px solid #ccc;cursor:pointer}
.friend.online{background:#d8ffd8}
.friend.offline{background:#eee}
.chat{height:180px;overflow:auto;border:1px solid #ccc;margin-bottom:5px;padding:5px}
input,button{margin:2px}
</style>
</head>
<body>

<div class="app">
  <div class="top">BubbleChat</div>

  <div class="sidebar">
    <input id="search" placeholder="–ü–æ–∏—Å–∫" oninput="loadFriends()">
    <div id="friends"></div>
  </div>

  <div class="content">
    <input id="nick" placeholder="–ù–∏–∫"><br>
    <input id="pass" placeholder="–ü–∞—Ä–æ–ª—å"><br>
    <input id="avatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—Å—Å—ã–ª–∫–∞)"><br>
    <button onclick="signup()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button onclick="login()">–í—Ö–æ–¥</button>
    <button onclick="logout()">–í—ã—Ö–æ–¥</button>

    <hr>

    <div id="chat" class="chat"></div>
    <input id="msg">
    <button onclick="send()">‚û§</button>
    <button onclick="block()">üö´</button>
    <button onclick="unblock()">‚úÖ</button>
    <button onclick="removeFriend()">‚ùå –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</button>

    <hr>

    <input id="newAvatar" placeholder="–ù–æ–≤–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞">
    <input id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
    <button onclick="updateProfile()">üíæ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

    <hr>

    <button onclick="roulette()">üé≤ –ß–∞—Ç-—Ä—É–ª–µ—Ç–∫–∞</button>
  </div>
</div>

<script>
let me=null, current=null;

async function signup(){
  await fetch("/api/signup",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({nick:nick.value,password:pass.value,avatar:avatar.value})});
  alert("–ì–æ—Ç–æ–≤–æ");
}

async function login(){
  const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({nick:nick.value,password:pass.value})});
  const d=await r.json();
  if(d.error){alert(d.error);return;}
  me=d.user.nick;
  loadFriends();
}

async function logout(){
  await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({nick:me})});
  me=null;
  alert("–í—ã—Ö–æ–¥");
}

async function loadFriends(){
  const r=await fetch("/api/users");
  const d=await r.json();
  const q=search.value.toLowerCase();
  friends.innerHTML="";
  d.filter(u=>u.nick.toLowerCase().includes(q)).forEach(u=>{
    if(u.nick!==me){
      const div=document.createElement("div");
      div.className="friend "+u.status;
      div.textContent=u.nick+" ("+u.status+")";
      div.onclick=()=>openChat(u.nick);
      friends.appendChild(div);
    }
  });
}

async function openChat(n){
  current=n;
  chat.innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...";
  const r = await fetch(/api/chat-history?me=${me}&friend=${current});
  const d = await r.json();
  chat.innerHTML="";
  d.forEach(m=>chat.innerHTML += ${m.from}: ${m.text}<br>);
}

async function send(){
  if(!current){alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞");return;}
  await fetch("/api/send",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({from:me,to:current,text:msg.value})});
  msg.value="";
}

async function block(){
  await fetch("/api/block",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({me:me,target:current})});
  alert("–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
}

async function unblock(){
  await fetch("/api/unblock",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({me:me,target:current})});
  alert("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
}

async function removeFriend(){
  await fetch("/api/remove-friend",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({me:me,friend:current})});
  alert("–£–¥–∞–ª–µ–Ω–æ –∏–∑ –¥—Ä—É–∑–µ–π");
  loadFriends();
  chat.innerHTML="";
}
async function updateProfile(){
  await fetch("/api/update-profile",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({me:me,avatar:newAvatar.value,password:newPass.value})});
  alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω");
  loadFriends();
}

async function roulette(){
  const r=await fetch("/api/roulette/join",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({nick:me})});
  const d=await r.json();
  if(d.match){
    current=d.match[0]==me?d.match[1]:d.match[0];
    alert("–¢–µ–±–µ –ø–æ–ø–∞–ª—Å—è: "+current);
  }else alert("–ü–æ–∏—Å–∫...");
}

// –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
setInterval(async ()=>{
  if(me && current){
    const r = await fetch(/api/chat-history?me=${me}&friend=${current});
    const d = await r.json();
    chat.innerHTML="";
    d.forEach(m=>chat.innerHTML += ${m.from}: ${m.text}<br>);
  }
},2000);
</script>

</body>
</html>
