<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>BubbleChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    margin: 0;
    background: #1a1a1a;
    font-family: monospace;
    color: white;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

#messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    font-size: 16px;
    word-break: break-word;
}

#inputBar {
    display: flex;
    padding: 10px;
    background: #111;
}

#msg {
    flex: 1;
    font-size: 16px;
    padding: 10px;
    background: #222;
    border: none;
    color: white;
}

#msg:focus { outline: none; }

.bubble {
    padding: 6px 10px;
    margin: 4px 0;
    background: #2b2b2b;
    border-radius: 5px;
}

.nick {
    font-weight: bold;
}

.mentionFlash {
    animation: flash 0.5s ease-in-out 4;
}

@keyframes flash {
    0% { background: #ff4444; }
    50% { background: #2b2b2b; }
    100% { background: #ff4444; }
}

</style>

</head>
<body>

<div id="messages"></div>

<div id="inputBar">
    <input id="msg" placeholder="Сообщение..." autocomplete="off">
</div>

<script>
let ws;
let myNick = "";
let myColor = "";
let messages = document.getElementById("messages");
let input = document.getElementById("msg");

// Аккуратный запрос ника
while (!myNick.trim()) {
    myNick = prompt("Введи свой ник для BubbleChat:");
}

ws = new WebSocket(location.origin.replace("http", "ws"));

ws.onopen = () => {
    ws.send(JSON.stringify({ type: "setNick", nick: myNick }));
};

ws.onmessage = e => {
    const data = JSON.parse(e.data);

    // История
    if (data.type === "history") {
        data.history.forEach(addMessage);
        return;
    }

    if (data.type === "chat") {
        addMessage(data.message);
    }
};

function addMessage(m) {
    let div = document.createElement("div");
    div.className = "bubble";

    div.innerHTML = 
        <span class="nick" style="color:${m.color}">@${m.nick}:</span>
        <span>${m.text}</span>
    ;

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;

    // Проверяем @упоминание
    if (m.text.includes("@" + myNick)) {
        div.classList.add("mentionFlash");
    }

    // Клик по нику → вставляет @ник
    div.querySelector(".nick").onclick = () => {
        input.value = "@" + m.nick + " ";
        input.focus();
    };
}

input.addEventListener("keydown", e => {
    if (e.key === "Enter" && input.value.trim() !== "") {
        ws.send(JSON.stringify({
            type: "chat",
            text: input.value
        }));
        input.value = "";
    }
});
</script>

</body>
</html>